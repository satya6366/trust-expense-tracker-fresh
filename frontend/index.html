<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vigneshwara Youth</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios@1.6.7/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.9/babel.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    .gradient-bg {
      background: linear-gradient(135deg, #1e3a8a, #3b82f6);
    }
    .card-shadow {
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    .hover-scale {
      transition: transform 0.2s;
    }
    .hover-scale:hover {
      transform: scale(1.05);
    }
    .table-row:hover {
      background-color: #f1f5f9;
    }
    .gradient-text {
      background: linear-gradient(to right, #3b82f6, #1e3a8a);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .password-container {
      position: relative;
    }
    .password-toggle {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      color: #6b7280;
    }
    .password-toggle:hover {
      color: #2563eb;
    }
  </style>
</head>
<body class="gradient-bg min-h-screen">
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;

    // Supabase client initialization
    const supabaseClient = supabase.createClient('https://tfdxzakwlhzsmwwwmull.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRmZHh6YWt3bGh6c213d3dtdWxsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MDAxMzEsImV4cCI6MjA3MDA3NjEzMX0.8ixbymPA53SChvcYk_Y-xX-6xI8006bDF7oi0UAmjgo');

    // Backend API URL
    const API_URL = 'https://trust-expense-tracker-fresh.onrender.com/api';

    // Language translations
    const translations = {
      en: {
        title: 'Vigneshwara Youth',
        subtitle: 'Hebbal Camp Kings',
        login: 'Login',
        signUp: 'Sign Up',
        email: 'Email',
        phone: 'Phone',
        password: 'Password',
        processing: 'Processing...',
        alreadyHaveAccount: 'Already have an account? Login',
        needAccount: 'Need an account? Sign Up',
        trustBalance: 'Trust Balance',
        addLoan: 'Add Loan',
        addExpense: 'Add Expense',
        addDonation: 'Add Donation',
        loans: 'Loans',
        expenses: 'Expenses',
        donations: 'Donations',
        notifications: 'Notifications',
        noLoans: 'No loans found.',
        borrower: 'Borrower Name',
        amount: 'Amount',
        interestAmount: 'Interest Amount',
        dueDate: 'Due Date',
        status: 'Status',
        action: 'Action',
        description: 'Description',
        date: 'Date',
        delete: 'Delete',
        deleting: 'Deleting...',
        edit: 'Edit',
        save: 'Save',
        cancel: 'Cancel',
        markCollected: 'Mark as Collected',
        collected: 'Collected',
        pending: 'Pending',
        logout: 'Logout',
        admin: 'Admin',
        user: 'User',
        currency: '₹',
        failedTryAgain: 'Failed, try again',
        languageToggle: 'తెలుగు',
      },
      te: {
        title: 'విగ్నేశ్వర యూత్',
        subtitle: 'హెబ్బాల్ క్యాంప్ కింగ్స్',
        login: 'లాగిన్',
        signUp: 'సైన్ అప్',
        email: 'ఇమెయిల్',
        phone: 'ఫోన్',
        password: 'పాస్వర్డ్',
        processing: 'ప్రాసెసింగ్...',
        alreadyHaveAccount: 'ఇప్పటికే ఖాతా ఉందా? లాగిన్',
        needAccount: 'ఖాతా కావాలా? సైన్ అప్',
        trustBalance: 'ట్రస్ట్ బ్యాలెన్స్',
        addLoan: 'రుణం జోడించు',
        addExpense: 'ఖర్చు జోడించు',
        addDonation: 'విరాళం జోడించు',
        loans: 'రుణాలు',
        expenses: 'ఖర్చులు',
        donations: 'విరాళాలు',
        notifications: 'నోటిఫికేషన్లు',
        noLoans: 'ఎటువంటి రుణాలు కనుగొనబడలేదు.',
        borrower: 'రుణగ్రహీత పేరు',
        amount: 'మొత్తం',
        interestAmount: 'వడ్డీ మొత్తం',
        dueDate: 'గడువు తేదీ',
        status: 'స్థితి',
        action: 'చర్య',
        description: 'వివరణ',
        date: 'తేదీ',
        delete: 'తొలగించు',
        deleting: 'తొలగిస్తోంది...',
        edit: 'సవరించు',
        save: 'సేవ్',
        cancel: 'రద్దు',
        markCollected: 'సేకరించినట్లు గుర్తించు',
        collected: 'సేకరించబడింది',
        pending: 'పెండింగ్',
        logout: 'లాగ్అవుట్',
        admin: 'అడ్మిన్',
        user: 'వినియోగదారు',
        currency: '₹',
        failedTryAgain: 'విఫలమైంది, మళ్లీ ప్రయత్నించండి',
        languageToggle: 'English',
      },
    };

    // Main App Component
    function App() {
      const [user, setUser] = useState(null);
      const [isAdmin, setIsAdmin] = useState(false);
      const [view, setView] = useState('login');
      const [language, setLanguage] = useState('en');

      useEffect(() => {
        const session = supabaseClient.auth.getSession();
        session.then(({ data }) => {
          if (data.session) {
            setUser(data.session.user);
            checkAdminStatus(data.session.user.id);
          }
        });

        supabaseClient.auth.onAuthStateChange((event, session) => {
          setUser(session ? session.user : null);
          if (session) checkAdminStatus(session.user.id);
        });
      }, []);

      const checkAdminStatus = async (userId) => {
        try {
          const response = await axios.get(`${API_URL}/users/${userId}/role`);
          setIsAdmin(response.data.role === 'admin');
        } catch (error) {
          console.error('Error checking admin status:', error);
          setIsAdmin(false);
        }
      };

      return (
        <div className="min-h-screen">
          {user ? (
            isAdmin ? (
              <AdminDashboard user={user} setView={setView} language={language} setLanguage={setLanguage} />
            ) : (
              <UserDashboard user={user} setView={setView} language={language} setLanguage={setLanguage} />
            )
          ) : (
            <Auth setView={setView} language={language} setLanguage={setLanguage} />
          )}
        </div>
      );
    }

    // Authentication Component
    function Auth({ setView, language, setLanguage }) {
      const [loginType, setLoginType] = useState('email');
      const [emailOrPhone, setEmailOrPhone] = useState('');
      const [password, setPassword] = useState('');
      const [isSignUp, setIsSignUp] = useState(false);
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);
      const [showPassword, setShowPassword] = useState(false);

      const handleAuth = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError('');
        try {
          if (isSignUp) {
            const { error } = await supabaseClient.auth.signUp(
              loginType === 'email' ? { email: emailOrPhone, password } : { phone: emailOrPhone, password }
            );
            if (error) throw error;
            setView('login');
            setIsSignUp(false);
          } else {
            const { error } = await supabaseClient.auth.signInWithPassword(
              loginType === 'email' ? { email: emailOrPhone, password } : { phone: emailOrPhone, password }
            );
            if (error) throw error;
          }
        } catch (err) {
          setError(err.message.includes('Invalid login') ? translations[language].failedTryAgain : err.message);
        } finally {
          setLoading(false);
        }
      };

      return (
        <div className="flex flex-col items-center justify-center min-h-screen px-4">
          <div className="text-center mb-6">
            <h1 className="text-4xl sm:text-5xl font-bold gradient-text">{translations[language].title}</h1>
            <p className="text-lg sm:text-xl text-white mt-2">{translations[language].subtitle}</p>
          </div>
          <div className="bg-white p-6 sm:p-8 rounded-xl card-shadow w-full max-w-md">
            <h2 className="text-2xl sm:text-3xl font-bold text-gray-800 mb-6 text-center">
              {isSignUp ? translations[language].signUp : translations[language].login}
            </h2>
            <div className="flex justify-between mb-4">
              <div className="flex">
                <button
                  className={`px-3 py-2 text-sm sm:text-base rounded-l-lg ${loginType === 'email' ? 'bg-blue-600 text-white' : 'bg-gray-200'}`}
                  onClick={() => setLoginType('email')}
                >
                  {translations[language].email}
                </button>
                <button
                  className={`px-3 py-2 text-sm sm:text-base rounded-r-lg ${loginType === 'phone' ? 'bg-blue-600 text-white' : 'bg-gray-200'}`}
                  onClick={() => setLoginType('phone')}
                >
                  {translations[language].phone}
                </button>
              </div>
              <button
                className="px-3 py-2 text-sm sm:text-base bg-gray-200 rounded-lg hover:bg-gray-300"
                onClick={() => setLanguage(language === 'en' ? 'te' : 'en')}
              >
                {translations[language].languageToggle}
              </button>
            </div>
            <form onSubmit={handleAuth}>
              <input
                type={loginType === 'email' ? 'email' : 'tel'}
                placeholder={loginType === 'email' ? translations[language].email : translations[language].phone}
                value={emailOrPhone}
                onChange={(e) => setEmailOrPhone(e.target.value)}
                className="w-full p-3 mb-4 border rounded-lg text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-blue-500"
                required
              />
              <div className="password-container">
                <input
                  type={showPassword ? 'text' : 'password'}
                  placeholder={translations[language].password}
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  className="w-full p-3 mb-4 border rounded-lg text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-blue-500"
                  required
                />
                <i
                  className={`fas ${showPassword ? 'fa-eye-slash' : 'fa-eye'} password-toggle`}
                  onClick={() => setShowPassword(!showPassword)}
                ></i>
              </div>
              <button
                type="submit"
                className="w-full bg-blue-600 text-white p-3 rounded-lg text-sm sm:text-base hover:bg-blue-700 hover-scale disabled:bg-blue-400"
                disabled={loading}
              >
                {loading ? translations[language].processing : isSignUp ? translations[language].signUp : translations[language].login}
              </button>
            </form>
            {error && <p className="text-red-500 mt-3 text-center text-sm sm:text-base">{error}</p>}
            <button
              onClick={() => {
                setIsSignUp(!isSignUp);
                setError('');
              }}
              className="mt-4 text-blue-600 hover:underline w-full text-center text-sm sm:text-base"
            >
              {isSignUp ? translations[language].alreadyHaveAccount : translations[language].needAccount}
            </button>
          </div>
        </div>
      );
    }

    // Admin Dashboard Component
    function AdminDashboard({ user, setView, language, setLanguage }) {
      const [trustBalance, setTrustBalance] = useState(0);
      const [loans, setLoans] = useState([]);
      const [newLoan, setNewLoan] = useState({ borrower: '', amount: '', interest: '' });
      const [expenses, setExpenses] = useState([]);
      const [newExpense, setNewExpense] = useState({ description: '', amount: '' });
      const [donations, setDonations] = useState([]);
      const [newDonation, setNewDonation] = useState({ description: '', amount: '' });
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');
      const [editingLoanId, setEditingLoanId] = useState(null);
      const [editLoan, setEditLoan] = useState({ borrower: '', amount: '', interest_amount: '', due_date: '' });

      useEffect(() => {
        fetchDashboardData();
        setupRealTimeSubscriptions();
      }, []);

      const fetchDashboardData = async () => {
        try {
          const [balanceRes, loansRes, expensesRes, donationsRes] = await Promise.all([
            axios.get(`${API_URL}/trust/balance`),
            axios.get(`${API_URL}/loans`),
            axios.get(`${API_URL}/expenses`),
            axios.get(`${API_URL}/donations`),
          ]);
          setTrustBalance(balanceRes.data.balance);
          setLoans(loansRes.data);
          setExpenses(expensesRes.data);
          setDonations(donationsRes.data);
          setError('');
        } catch (error) {
          console.error('Error fetching dashboard data:', error);
          setError(translations[language].failedTryAgain);
        }
      };

      const setupRealTimeSubscriptions = () => {
        supabaseClient
          .channel('loans')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'loans' }, () => {
            fetchDashboardData();
          })
          .subscribe();
      };

      const addLoan = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError('');
        try {
          const interestAmount = (parseFloat(newLoan.amount) * parseFloat(newLoan.interest) / 100).toFixed(2);
          await axios.post(`${API_URL}/loans`, { 
            ...newLoan, 
            interest_amount: interestAmount, 
            user_id: user.id,
            is_collected: false 
          });
          setNewLoan({ borrower: '', amount: '', interest: '' });
          fetchDashboardData();
        } catch (error) {
          console.error('Error adding loan:', error);
          setError(error.response?.data?.error || translations[language].failedTryAgain);
        } finally {
          setLoading(false);
        }
      };

      const editLoanStart = (loan) => {
        setEditingLoanId(loan._id);
        setEditLoan({
          borrower: loan.borrower,
          amount: loan.amount,
          interest_amount: loan.interest_amount,
          due_date: new Date(loan.due_date).toISOString().split('T')[0]
        });
      };

      const saveLoanEdit = async (loanId) => {
        setLoading(true);
        setError('');
        try {
          await axios.put(`${API_URL}/loans/${loanId}`, { 
            ...editLoan, 
            user_id: user.id,
            due_date: new Date(editLoan.due_date).toISOString()
          });
          setEditingLoanId(null);
          setEditLoan({ borrower: '', amount: '', interest_amount: '', due_date: '' });
          fetchDashboardData();
        } catch (error) {
          console.error('Error editing loan:', error);
          setError(error.response?.data?.error || translations[language].failedTryAgain);
        } finally {
          setLoading(false);
        }
      };

      const cancelEdit = () => {
        setEditingLoanId(null);
        setEditLoan({ borrower: '', amount: '', interest_amount: '', due_date: '' });
      };

      const markLoanCollected = async (loanId, amount, interestAmount) => {
        setLoading(true);
        setError('');
        try {
          await axios.put(`${API_URL}/loans/${loanId}/collect`, { 
            user_id: user.id,
            amount: parseFloat(amount),
            interest_amount: parseFloat(interestAmount)
          });
          fetchDashboardData();
        } catch (error) {
          console.error('Error marking loan as collected:', error);
          setError(error.response?.data?.error || translations[language].failedTryAgain);
        } finally {
          setLoading(false);
        }
      };

      const deleteLoan = async (loanId) => {
        setLoading(true);
        setError('');
        try {
          await axios.delete(`${API_URL}/loans/${loanId}`, { data: { user_id: user.id } });
          fetchDashboardData();
        } catch (error) {
          console.error('Error deleting loan:', error);
          setError(error.response?.data?.error || translations[language].failedTryAgain);
        } finally {
          setLoading(false);
        }
      };

      const addExpense = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError('');
        try {
          await axios.post(`${API_URL}/expenses`, { ...newExpense, user_id: user.id });
          setNewExpense({ description: '', amount: '' });
          fetchDashboardData();
        } catch (error) {
          console.error('Error adding expense:', error);
          setError(error.response?.data?.error || translations[language].failedTryAgain);
        } finally {
          setLoading(false);
        }
      };

      const addDonation = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError('');
        try {
          await axios.post(`${API_URL}/donations`, { ...newDonation, user_id: user.id });
          setNewDonation({ description: '', amount: '' });
          fetchDashboardData();
        } catch (error) {
          console.error('Error adding donation:', error);
          setError(error.response?.data?.error || translations[language].failedTryAgain);
        } finally {
          setLoading(false);
        }
      };

      const deleteExpense = async (expenseId) => {
        setLoading(true);
        setError('');
        try {
          await axios.delete(`${API_URL}/expenses/${expenseId}`, { data: { user_id: user.id } });
          fetchDashboardData();
        } catch (error) {
          console.error('Error deleting expense:', error);
          setError(error.response?.data?.error || translations[language].failedTryAgain);
        } finally {
          setLoading(false);
        }
      };

      const deleteDonation = async (donationId) => {
        setLoading(true);
        setError('');
        try {
          await axios.delete(`${API_URL}/donations/${donationId}`, { data: { user_id: user.id } });
          fetchDashboardData();
        } catch (error) {
          console.error('Error deleting donation:', error);
          setError(error.response?.data?.error || translations[language].failedTryAgain);
        } finally {
          setLoading(false);
        }
      };

      const logout = async () => {
        await supabaseClient.auth.signOut();
        setView('login');
      };

      return (
        <div className="container mx-auto p-4 sm:p-6 bg-gray-50 min-h-screen">
          <div className="flex flex-col sm:flex-row justify-between items-center mb-4 sm:mb-6">
            <div className="text-center sm:text-left mb-4 sm:mb-0">
              <h1 className="text-3xl sm:text-4xl font-bold gradient-text">{translations[language].title}</h1>
              <p className="text-base sm:text-lg text-gray-700">{translations[language].subtitle}</p>
              <span className="ml-0 sm:ml-3 bg-blue-100 text-blue-800 text-sm px-2 py-1 rounded inline-block mt-2">{translations[language].admin}</span>
            </div>
            <div className="flex items-center space-x-4">
              <button
                className="px-3 py-2 text-sm sm:text-base bg-gray-200 rounded-lg hover:bg-gray-300"
                onClick={() => setLanguage(language === 'en' ? 'te' : 'en')}
              >
                {translations[language].languageToggle}
              </button>
              <button onClick={logout} className="bg-red-600 text-white px-3 py-2 rounded-lg text-sm sm:text-base hover:bg-red-700 hover-scale">
                {translations[language].logout}
              </button>
            </div>
          </div>
          {error && <p className="text-red-500 mb-4 text-center text-sm sm:text-base">{error}</p>}
          <div className="bg-white p-4 sm:p-6 rounded-xl card-shadow mb-4 sm:mb-6">
            <h2 className="text-xl sm:text-2xl font-semibold text-gray-800">{translations[language].trustBalance}: {translations[language].currency}{trustBalance}</h2>
          </div>
          <div className="flex flex-col md:grid md:grid-cols-3 gap-4 sm:gap-6 mb-4 sm:mb-6">
            <div className="bg-white p-4 sm:p-6 rounded-xl card-shadow">
              <h2 className="text-lg sm:text-xl font-semibold text-gray-800 mb-4">{translations[language].addLoan}</h2>
              <form onSubmit={addLoan}>
                <input
                  type="text"
                  placeholder={translations[language].borrower}
                  value={newLoan.borrower}
                  onChange={(e) => setNewLoan({ ...newLoan, borrower: e.target.value })}
                  className="w-full p-2 sm:p-3 mb-3 border rounded-lg text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-blue-500"
                  required
                />
                <input
                  type="number"
                  placeholder={translations[language].amount}
                  value={newLoan.amount}
                  onChange={(e) => setNewLoan({ ...newLoan, amount: e.target.value })}
                  className="w-full p-2 sm:p-3 mb-3 border rounded-lg text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-blue-500"
                  required
                />
                <input
                  type="number"
                  placeholder={translations[language].interest}
                  value={newLoan.interest}
                  onChange={(e) => setNewLoan({ ...newLoan, interest: e.target.value })}
                  className="w-full p-2 sm:p-3 mb-3 border rounded-lg text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-blue-500"
                  required
                />
                <button
                  type="submit"
                  className="w-full bg-blue-600 text-white p-2 sm:p-3 rounded-lg text-sm sm:text-base hover:bg-blue-700 hover-scale disabled:bg-blue-400"
                  disabled={loading}
                >
                  {loading ? translations[language].processing : translations[language].addLoan}
                </button>
              </form>
            </div>
            <div className="bg-white p-4 sm:p-6 rounded-xl card-shadow">
              <h2 className="text-lg sm:text-xl font-semibold text-gray-800 mb-4">{translations[language].addExpense}</h2>
              <form onSubmit={addExpense}>
                <input
                  type="text"
                  placeholder={translations[language].description}
                  value={newExpense.description}
                  onChange={(e) => setNewExpense({ ...newExpense, description: e.target.value })}
                  className="w-full p-2 sm:p-3 mb-3 border rounded-lg text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-blue-500"
                  required
                />
                <input
                  type="number"
                  placeholder={translations[language].amount}
                  value={newExpense.amount}
                  onChange={(e) => setNewExpense({ ...newExpense, amount: e.target.value })}
                  className="w-full p-2 sm:p-3 mb-3 border rounded-lg text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-blue-500"
                  required
                />
                <button
                  type="submit"
                  className="w-full bg-blue-600 text-white p-2 sm:p-3 rounded-lg text-sm sm:text-base hover:bg-blue-700 hover-scale disabled:bg-blue-400"
                  disabled={loading}
                >
                  {loading ? translations[language].processing : translations[language].addExpense}
                </button>
              </form>
            </div>
            <div className="bg-white p-4 sm:p-6 rounded-xl card-shadow">
              <h2 className="text-lg sm:text-xl font-semibold text-gray-800 mb-4">{translations[language].addDonation}</h2>
              <form onSubmit={addDonation}>
                <input
                  type="text"
                  placeholder={translations[language].description}
                  value={newDonation.description}
                  onChange={(e) => setNewDonation({ ...newDonation, description: e.target.value })}
                  className="w-full p-2 sm:p-3 mb-3 border rounded-lg text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-blue-500"
                  required
                />
                <input
                  type="number"
                  placeholder={translations[language].amount}
                  value={newDonation.amount}
                  onChange={(e) => setNewDonation({ ...newDonation, amount: e.target.value })}
                  className="w-full p-2 sm:p-3 mb-3 border rounded-lg text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-blue-500"
                  required
                />
                <button
                  type="submit"
                  className="w-full bg-blue-600 text-white p-2 sm:p-3 rounded-lg text-sm sm:text-base hover:bg-blue-700 hover-scale disabled:bg-blue-400"
                  disabled={loading}
                >
                  {loading ? translations[language].processing : translations[language].addDonation}
                </button>
              </form>
            </div>
          </div>
          <div className="bg-white p-4 sm:p-6 rounded-xl card-shadow mb-4 sm:mb-6">
            <h2 className="text-lg sm:text-xl font-semibold text-gray-800 mb-4">{translations[language].loans}</h2>
            <div className="overflow-x-auto">
              <table className="w-full border-collapse text-sm sm:text-base">
                <thead>
                  <tr className="bg-gray-100">
                    <th className="border p-2 sm:p-3 text-left">{translations[language].borrower}</th>
                    <th className="border p-2 sm:p-3 text-left">{translations[language].amount}</th>
                    <th className="border p-2 sm:p-3 text-left">{translations[language].interestAmount}</th>
                    <th className="border p-2 sm:p-3 text-left">{translations[language].dueDate}</th>
                    <th className="border p-2 sm:p-3 text-left">{translations[language].status}</th>
                    <th className="border p-2 sm:p-3 text-left">{translations[language].action}</th>
                  </tr>
                </thead>
                <tbody>
                  {loans.map((loan, index) => (
                    <tr key={loan._id} className={`table-row ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`}>
                      {editingLoanId === loan._id ? (
                        <>
                          <td className="border p-2 sm:p-3">
                            <input
                              type="text"
                              value={editLoan.borrower}
                              onChange={(e) => setEditLoan({ ...editLoan, borrower: e.target.value })}
                              className="w-full p-1 border rounded"
                            />
                          </td>
                          <td className="border p-2 sm:p-3">
                            <input
                              type="number"
                              value={editLoan.amount}
                              onChange={(e) => setEditLoan({ ...editLoan, amount: e.target.value })}
                              className="w-full p-1 border rounded"
                            />
                          </td>
                          <td className="border p-2 sm:p-3">
                            <input
                              type="number"
                              value={editLoan.interest_amount}
                              onChange={(e) => setEditLoan({ ...editLoan, interest_amount: e.target.value })}
                              className="w-full p-1 border rounded"
                            />
                          </td>
                          <td className="border p-2 sm:p-3">
                            <input
                              type="date"
                              value={editLoan.due_date}
                              onChange={(e) => setEditLoan({ ...editLoan, due_date: e.target.value })}
                              className="w-full p-1 border rounded"
                            />
                          </td>
                          <td className="border p-2 sm:p-3">{loan.is_collected ? translations[language].collected : translations[language].pending}</td>
                          <td className="border p-2 sm:p-3 flex space-x-2">
                            <button
                              onClick={() => saveLoanEdit(loan._id)}
                              className="bg-green-600 text-white px-2 sm:px-3 py-1 rounded-lg text-xs sm:text-sm hover:bg-green-700 hover-scale disabled:bg-green-400"
                              disabled={loading}
                            >
                              {translations[language].save}
                            </button>
                            <button
                              onClick={cancelEdit}
                              className="bg-gray-600 text-white px-2 sm:px-3 py-1 rounded-lg text-xs sm:text-sm hover:bg-gray-700 hover-scale"
                            >
                              {translations[language].cancel}
                            </button>
                          </td>
                        </>
                      ) : (
                        <>
                          <td className="border p-2 sm:p-3">{loan.borrower}</td>
                          <td className="border p-2 sm:p-3">{translations[language].currency}{loan.amount}</td>
                          <td className="border p-2 sm:p-3">{translations[language].currency}{loan.interest_amount}</td>
                          <td className="border p-2 sm:p-3">{new Date(loan.due_date).toLocaleDateString()}</td>
                          <td className="border p-2 sm:p-3">{loan.is_collected ? translations[language].collected : translations[language].pending}</td>
                          <td className="border p-2 sm:p-3 flex space-x-2">
                            {!loan.is_collected && (
                              <button
                                onClick={() => markLoanCollected(loan._id, loan.amount, loan.interest_amount)}
                                className="bg-blue-600 text-white px-2 sm:px-3 py-1 rounded-lg text-xs sm:text-sm hover:bg-blue-700 hover-scale disabled:bg-blue-400"
                                disabled={loading}
                              >
                                {translations[language].markCollected}
                              </button>
                            )}
                            <button
                              onClick={() => editLoanStart(loan)}
                              className="bg-yellow-600 text-white px-2 sm:px-3 py-1 rounded-lg text-xs sm:text-sm hover:bg-yellow-700 hover-scale disabled:bg-yellow-400"
                              disabled={loading}
                            >
                              {translations[language].edit}
                            </button>
                            <button
                              onClick={() => deleteLoan(loan._id)}
                              className="bg-red-600 text-white px-2 sm:px-3 py-1 rounded-lg text-xs sm:text-sm hover:bg-red-700 hover-scale disabled:bg-red-400"
                              disabled={loading}
                            >
                              {loading ? translations[language].deleting : translations[language].delete}
                            </button>
                          </td>
                        </>
                      )}
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
          <div className="bg-white p-4 sm:p-6 rounded-xl card-shadow mb-4 sm:mb-6">
            <h2 className="text-lg sm:text-xl font-semibold text-gray-800 mb-4">{translations[language].expenses}</h2>
            <div className="overflow-x-auto">
              <table className="w-full border-collapse text-sm sm:text-base">
                <thead>
                  <tr className="bg-gray-100">
                    <th className="border p-2 sm:p-3 text-left">{translations[language].description}</th>
                    <th className="border p-2 sm:p-3 text-left">{translations[language].amount}</th>
                    <th className="border p-2 sm:p-3 text-left">{translations[language].date}</th>
                    <th className="border p-2 sm:p-3 text-left">{translations[language].action}</th>
                  </tr>
                </thead>
                <tbody>
                  {expenses.map((expense, index) => (
                    <tr key={expense._id} className={`table-row ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`}>
                      <td className="border p-2 sm:p-3">{expense.description}</td>
                      <td className="border p-2 sm:p-3">{translations[language].currency}{expense.amount}</td>
                      <td className="border p-2 sm:p-3">{new Date(expense.created_at).toLocaleDateString()}</td>
                      <td className="border p-2 sm:p-3">
                        <button
                          onClick={() => deleteExpense(expense._id)}
                          className="bg-red-600 text-white px-2 sm:px-3 py-1 rounded-lg text-xs sm:text-sm hover:bg-red-700 hover-scale disabled:bg-red-400"
                          disabled={loading}
                        >
                          {loading ? translations[language].deleting : translations[language].delete}
                        </button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
          <div className="bg-white p-4 sm:p-6 rounded-xl card-shadow">
            <h2 className="text-lg sm:text-xl font-semibold text-gray-800 mb-4">{translations[language].donations}</h2>
            <div className="overflow-x-auto">
              <table className="w-full border-collapse text-sm sm:text-base">
                <thead>
                  <tr className="bg-gray-100">
                    <th className="border p-2 sm:p-3 text-left">{translations[language].description}</th>
                    <th className="border p-2 sm:p-3 text-left">{translations[language].amount}</th>
                    <th className="border p-2 sm:p-3 text-left">{translations[language].date}</th>
                    <th className="border p-2 sm:p-3 text-left">{translations[language].action}</th>
                  </tr>
                </thead>
                <tbody>
                  {donations.map((donation, index) => (
                    <tr key={donation._id} className={`table-row ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`}>
                      <td className="border p-2 sm:p-3">{donation.description}</td>
                      <td className="border p-2 sm:p-3">{translations[language].currency}{donation.amount}</td>
                      <td className="border p-2 sm:p-3">{new Date(donation.created_at).toLocaleDateString()}</td>
                      <td className="border p-2 sm:p-3">
                        <button
                          onClick={() => deleteDonation(donation._id)}
                          className="bg-red-600 text-white px-2 sm:px-3 py-1 rounded-lg text-xs sm:text-sm hover:bg-red-700 hover-scale disabled:bg-red-400"
                          disabled={loading}
                        >
                          {loading ? translations[language].deleting : translations[language].delete}
                        </button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      );
    }

    // User Dashboard Component
    function UserDashboard({ user, setView, language, setLanguage }) {
      const [trustBalance, setTrustBalance] = useState(0);
      const [loans, setLoans] = useState([]);
      const [expenses, setExpenses] = useState([]);
      const [donations, setDonations] = useState([]);
      const [notifications, setNotifications] = useState([]);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');

      useEffect(() => {
        fetchDashboardData();
        setupRealTimeSubscriptions();
      }, []);

      const fetchDashboardData = async () => {
        try {
          const [balanceRes, loansRes, expensesRes, donationsRes, notificationsRes] = await Promise.all([
            axios.get(`${API_URL}/trust/balance`),
            axios.get(`${API_URL}/loans`),
            axios.get(`${API_URL}/expenses`),
            axios.get(`${API_URL}/donations`),
            supabaseClient.from('notifications').select('*').eq('user_id', user.id),
          ]);
          setTrustBalance(balanceRes.data.balance);
          setLoans(loansRes.data);
          setExpenses(expensesRes.data);
          setDonations(donationsRes.data);
          setNotifications(notificationsRes.data || []);
          setError('');
        } catch (error) {
          console.error('Error fetching dashboard data:', error);
          setError(translations[language].failedTryAgain);
        }
      };

      const setupRealTimeSubscriptions = () => {
        supabaseClient
          .channel('notifications')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'notifications', filter: `user_id=eq.${user.id}` }, (payload) => {
            setNotifications((prev) => [...prev, payload.new]);
          })
          .subscribe();
        supabaseClient
          .channel('loans')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'loans' }, () => {
            fetchDashboardData();
          })
          .subscribe();
      };

      const deleteLoan = async (loanId) => {
        setLoading(true);
        setError('');
        try {
          await axios.delete(`${API_URL}/loans/${loanId}`, { data: { user_id: user.id } });
          fetchDashboardData();
        } catch (error) {
          console.error('Error deleting loan:', error);
          setError(error.response?.data?.error || translations[language].failedTryAgain);
        } finally {
          setLoading(false);
        }
      };

      const logout = async () => {
        await supabaseClient.auth.signOut();
        setView('login');
      };

      return (
        <div className="container mx-auto p-4 sm:p-6 bg-gray-50 min-h-screen">
          <div className="flex flex-col sm:flex-row justify-between items-center mb-4 sm:mb-6">
            <div className="text-center sm:text-left mb-4 sm:mb-0">
              <h1 className="text-3xl sm:text-4xl font-bold gradient-text">{translations[language].title}</h1>
              <p className="text-base sm:text-lg text-gray-700">{translations[language].subtitle}</p>
              <span className="ml-0 sm:ml-3 bg-green-100 text-green-800 text-sm px-2 py-1 rounded inline-block mt-2">{translations[language].user}</span>
            </div>
            <div className="flex items-center space-x-4">
              <button
                className="px-3 py-2 text-sm sm:text-base bg-gray-200 rounded-lg hover:bg-gray-300"
                onClick={() => setLanguage(language === 'en' ? 'te' : 'en')}
              >
                {translations[language].languageToggle}
              </button>
              <button onClick={logout} className="bg-red-600 text-white px-3 py-2 rounded-lg text-sm sm:text-base hover:bg-red-700 hover-scale">
                {translations[language].logout}
              </button>
            </div>
          </div>
          {error && <p className="text-red-500 mb-4 text-center text-sm sm:text-base">{error}</p>}
          <div className="bg-white p-4 sm:p-6 rounded-xl card-shadow mb-4 sm:mb-6">
            <h2 className="text-xl sm:text-2xl font-semibold text-gray-800">{translations[language].trustBalance}: {translations[language].currency}{trustBalance}</h2>
          </div>
          <div className="bg-white p-4 sm:p-6 rounded-xl card-shadow mb-4 sm:mb-6">
            <h2 className="text-lg sm:text-xl font-semibold text-gray-800 mb-4">{translations[language].loans}</h2>
            {loans.length === 0 && <p className="text-gray-600">{translations[language].noLoans}</p>}
            <div className="overflow-x-auto">
              <table className="w-full border-collapse text-sm sm:text-base">
                <thead>
                  <tr className="bg-gray-100">
                    <th className="border p-2 sm:p-3 text-left">{translations[language].borrower}</th>
                    <th className="border p-2 sm:p-3 text-left">{translations[language].amount}</th>
                    <th className="border p-2 sm:p-3 text-left">{translations[language].interestAmount}</th>
                    <th className="border p-2 sm:p-3 text-left">{translations[language].dueDate}</th>
                    <th className="border p-2 sm:p-3 text-left">{translations[language].status}</th>
                    <th className="border p-2 sm:p-3 text-left">{translations[language].action}</th>
                  </tr>
                </thead>
                <tbody>
                  {loans.map((loan, index) => (
                    <tr key={loan._id} className={`table-row ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`}>
                      <td className="border p-2 sm:p-3">{loan.borrower}</td>
                      <td className="border p-2 sm:p-3">{translations[language].currency}{loan.amount}</td>
                      <td className="border p-2 sm:p-3">{translations[language].currency}{loan.interest_amount}</td>
                      <td className="border p-2 sm:p-3">{new Date(loan.due_date).toLocaleDateString()}</td>
                      <td className="border p-2 sm:p-3">{loan.is_collected ? translations[language].collected : translations[language].pending}</td>
                      <td className="border p-2 sm:p-3">
                        <button
                          onClick={() => deleteLoan(loan._id)}
                          className="bg-red-600 text-white px-2 sm:px-3 py-1 rounded-lg text-xs sm:text-sm hover:bg-red-700 hover-scale disabled:bg-red-400"
                          disabled={loading}
                        >
                          {loading ? translations[language].deleting : translations[language].delete}
                        </button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
          <div className="bg-white p-4 sm:p-6 rounded-xl card-shadow mb-4 sm:mb-6">
            <h2 className="text-lg sm:text-xl font-semibold text-gray-800 mb-4">{translations[language].expenses}</h2>
            <div className="overflow-x-auto">
              <table className="w-full border-collapse text-sm sm:text-base">
                <thead>
                  <tr className="bg-gray-100">
                    <th className="border p-2 sm:p-3 text-left">{translations[language].description}</th>
                    <th className="border p-2 sm:p-3 text-left">{translations[language].amount}</th>
                    <th className="border p-2 sm:p-3 text-left">{translations[language].date}</th>
                  </tr>
                </thead>
                <tbody>
                  {expenses.map((expense, index) => (
                    <tr key={expense._id} className={`table-row ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`}>
                      <td className="border p-2 sm:p-3">{expense.description}</td>
                      <td className="border p-2 sm:p-3">{translations[language].currency}{expense.amount}</td>
                      <td className="border p-2 sm:p-3">{new Date(expense.created_at).toLocaleDateString()}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
          <div className="bg-white p-4 sm:p-6 rounded-xl card-shadow mb-4 sm:mb-6">
            <h2 className="text-lg sm:text-xl font-semibold text-gray-800 mb-4">{translations[language].donations}</h2>
            <div className="overflow-x-auto">
              <table className="w-full border-collapse text-sm sm:text-base">
                <thead>
                  <tr className="bg-gray-100">
                    <th className="border p-2 sm:p-3 text-left">{translations[language].description}</th>
                    <th className="border p-2 sm:p-3 text-left">{translations[language].amount}</th>
                    <th className="border p-2 sm:p-3 text-left">{translations[language].date}</th>
                  </tr>
                </thead>
                <tbody>
                  {donations.map((donation, index) => (
                    <tr key={donation._id} className={`table-row ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`}>
                      <td className="border p-2 sm:p-3">{donation.description}</td>
                      <td className="border p-2 sm:p-3">{translations[language].currency}{donation.amount}</td>
                      <td className="border p-2 sm:p-3">{new Date(donation.created_at).toLocaleDateString()}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
          <div className="bg-white p-4 sm:p-6 rounded-xl card-shadow">
            <h2 className="text-lg sm:text-xl font-semibold text-gray-800 mb-4">{translations[language].notifications}</h2>
            <ul className="list-disc pl-5 text-sm sm:text-base">
              {notifications.map((notification) => (
                <li key={notification.id} className="mb-2 text-gray-700">
                  {notification.message} - {new Date(notification.created_at).toLocaleString()}
                </li>
              ))}
            </ul>
          </div>
        </div>
      );
    }

    // Render the App
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>